### Description of the databases [here](<../Week_01/movie_pc_ships.pdf/>)

### Scripts of the databases [here](<../Week_01/Scripts/>)

# Упражнение 5 - Групови функции и агрегиране на данни

Ще разгледаме функциите, които приемат множество от редове и връщат 1 резултат:

-   следните работят за числа и символни низове
  
`COUNT` - връща броят на редовете

`MIN` - връща най-ниската стойност

`MAX` - връща най-високата стойност

- следните работят само за числа

`SUM` - връща сумата
  
`AVG` - връща средноаритметичната стойност

Тези функции игнорират NULL стойностите с изключение на:

`COUNT(*)` - брои всички редове дори с null стойности

#### Във функциите може да добавим ключовите думи ALL|DISTINCT

*Примери:*

```sql
COUNT(ALL starname)
```
по default се подразбира, че използваме функцията с ALL

```sql
COUNT(DISTINCT starname)
```
Ще преброи редовете с уникални имена

## Създаване на групи от данни

Данни групираме чрез `GROUP BY` клаузата, която стои най-накрая

Тоест:

|emp_name|salary|dep_id|
|--------|------|------|
| A      | 1000 | 1    |
| B      | 2000 | 1    |

Ако групираме по следния начин

```sql
SELECT --
FROM --
WHERE --
GROUP BY dep_id
```
Двата ни реда с еднакъв `dep_id` ще попаднат в 1 група (за 1 група ще отговаря 1 ред)

Сложим ли групова функция в `SELECT`, тя ще се изпълни за всяка група по отделно и ще върне резултат

### Последователност на изпълнение

```sql
SELECT dep_id, AVG(salary) AS group_avg    -- 3-то
FROM Employee                              -- 1-во
GROUP BY dep_id, job_id                    -- 2-ро
```

### HAVING клауза

Чрез клаузата `HAVING group_condition` въвеждаме условие, което всяка група трябва да изпълнява, за да се включи в крайния резултат

Слагаме я след `GROUP BY`

### Няколко забележки

- Използваме груповите функции в `SELECT` клаузата или `HAVING` клаузата (за HAVING не е споменато на упражнения, но е валидно)

- Въвеждаме функциите `CONVERT()` И `DECIMAL()`, за да обработим числения резултат

  Тоест:

  **CONVERT( DECIMAL( PRECISION, SCALE ), NUMBER )**

  - `PRECISION` - колко символа общо ще бъде нашето число

  - `SCALE` - до колко цифри след десетичната запетая закръгляме

- Добре е да добавяме имена на колоните, които получаваме от груповите функции, иначе те не получават име, тоест: `(No colomn name)`

- Не можем да сложим колона от таблицата в `SELECT` клаузата, ако тя не е спомената в `GROUP BY` клаузата

## Трансформиране на NULL стойности

Чрез `ISNULL(check_expr, repl_value)` функцията

- `check_expr` - стойност, която проверяваме дали е null
- `repl_value` - заменяме null стойността с тази стойност)

Полезно е при използването на групови функции, които не работят съвместно с null стойности

- Null стойностите могат да образуват група:
  
  Нека разгледаме таблицата R
  | a  | b  |
  |----|----|
  |null|null|

  Ако приложим:

  ```sql
  SELECT a, COUNT(b) AS cb
  FROM R
  GROUP BY a;
  ```
  Ще получим:

  | a  | cb |
  |----|----|
  |null| 0  |

  Защото няма клетки в b без null стойности

  Ако приложим:
  ```sql
  SELECT a, SUM(b) AS cb
  FROM R
  GROUP BY a;
  ```
  Ще получим:

  | a  | cb |
  |----|----|
  |null|null|

  Защото само върху празното множество извършваме изчислителната операция, тоест получаваме празното множество


  
