# Упражнение 11 - Твърдения и тригери

Това са активни елементи, управлявани от СУБД

## Твърдения (Assertions)

Ограничение на ниво схема на базата данни.
Булеви изрази, които винаги трябва да са верни. (при създаването и при промените после)

### Създаване 

```sql
CREATE ASSERTION <name>
CHECK <condition>;
```

`CHECK` се проверява при `INSERT` и `UPDATE`. Твърдението се проверява за всяка таблица, участваща в базата данни, при извършването на коя да е модификация.
Твърдения не се поддържат от 

### Разлика с CHECK ограниченията

При `CHECK` ограничения, чиито условия съдържат подзаявки, условието на ограничението не
винаги води до рестрикция на стойностите, които се
вмъкват в таблицата. Твърденията се дефинират на ниво схема на базата от
данни, а `CHECK` ограниченията на ниво таблица. Тоест твърденията обхващат повече от 1 таблица. Твърденията се проверяват при всяка модификация, `CHECK` се проверява при `INSERT` и `UPDATE`.

### Изтриване 

```sql
DROP ASSERTION <name>;
```

## Тригери (Triggers)

Тригерите са обекти в базата данни. Създават се за конкретна таблица/изглед. Съвкупност от операции, които се изпълняват от СУБД при настъпване на дадено събитие (DELETE, INSERT, UPDATE), ако е удовлетворено условието - извършват действие.
Работят с данните преди и след модификацията.
Тригерите
могат да проверяват условия и да променят
данните. (Твърдеднията само проверяват условия)

### Създаване

```sql
CREATE TRIGGER <name>
ON { table | view }
{ FOR | AFTER | INSTEAD OF }
{ [ INSERT ] [ , ] [ UPDATE ] [ , ]
[ DELETE ] }
AS
{ sql_statement }
```

Достъпът до стойностите на кортежите преди
и след настъпване на събитието се
осъществява посредством специални таблици.
В MS SQL това са таблиците INSERTED и DELETED

| DML command | Temporary Table | Description |
|-|-|-|
| INSERT | INSERTED | Съдържа данните, които току-що са били вмъкнати |
| DELETE | DELETED | Съдържа данните, които току-що са били премахнати |
| UPDATE | INSERTED | Съдържа копие на данните след обновяването |
| | DELETED | Съдържа копие на данните преди обновяването |


- AFTER тригери - **Създават се само за таблица**. Може да има няколко after triggers за команда.

Първо се проверяват ограниченията на таблицата. Ако не са удовлетворени - не се изпълнява тригера. Ако са удовлетворени, се извършва модификацията и след това се изпълнява и тригера.

- INSTEAD OF тригери - За таблица и изглед. **Само един за дадена операция**

Вместо дадена модификация, да се изпълни тригера преди да се проверят ограниченията върху таблицата.

- AFTER и INSTED OF тригери

Първо се изпълнява INSTEAD OF, после AFTER.
